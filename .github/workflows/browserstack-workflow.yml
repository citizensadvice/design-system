name: BrowserStack

# @TODO: Use page_build event to only trigger when docs are updated
on: [push]

jobs:
  browserstack:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - config: 'Windows_10_85'
            browser: 'chrome'
            browserstack_username: 'PRO_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'PRO_BROWSERSTACK_ACCESS_KEY'
          - config: 'Windows_10_81'
            browser: 'firefox'
            browserstack_username: 'PRO_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'PRO_BROWSERSTACK_ACCESS_KEY'
          - config: 'Windows_7_80'
            browser: 'chrome'
            browserstack_username: 'PRO_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'PRO_BROWSERSTACK_ACCESS_KEY'
          - config: 'Windows_7_78'
            browser: 'firefox'
            browserstack_username: 'PRO_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'PRO_BROWSERSTACK_ACCESS_KEY'
          - config: 'OSX_Mojave_84'
            browser: 'chrome'
            browserstack_username: 'PRO_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'PRO_BROWSERSTACK_ACCESS_KEY'
          - config: 'OSX_Mojave_12'
            browser: 'safari'
            browserstack_username: 'PRO_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'PRO_BROWSERSTACK_ACCESS_KEY'
          - config: 'iPhone11_13'
            browser: 'ios'
            browserstack_username: 'MOBILE_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'MOBILE_BROWSERSTACK_ACCESS_KEY'
          - config: 'iPhone8_12'
            browser: 'ios'
            browserstack_username: 'MOBILE_BROWSERSTACK_USERNAME'
            browserstack_access_key: 'MOBILE_BROWSERSTACK_ACCESS_KEY'
    steps:
      - uses: actions/checkout@v2
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - run: bundle exec rake design_system:all
        env:
          # Fake the DOCKER_TAG for browser stack builds
          # @TODO: Refactor this to be less coupled to the build environment
          DOCKER_TAG: ${{ format('design-system/PR-987_{0}', github.sha) }}
          BROWSERSTACK: true
          HEADLESS: false
          GRID: false
          LOG_LOCATION: automation_logs.log
          BROWSER: ${{ matrix.browser }}
          BROWSERSTACK_CONFIGURATION_OPTIONS: ${{ matrix.config }}
          BROWSERSTACK_USERNAME: ${{ secrets[matrix.browserstack_username] }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets[matrix.browserstack_access_key] }}
      - uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: grid-artifacts
          path: testing/artifacts
          retention-days: 2
